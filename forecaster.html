<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exceptional Spending Forecaster</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom CSS for elements not easily handled by utility classes */
        .sidebar-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1.25rem; /* 12px 20px */
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .sidebar-item:hover {
            background-color: #475569; /* slate-600 */
        }

        /* Hide text by default */
        .sidebar-item span {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            white-space: nowrap;
        }

        /* Show text on sidebar hover */
        #sidebar:hover .sidebar-item span {
            opacity: 1;
        }

        /* Ensure large numbers in key figures don't wrap by using responsive font size */
        .key-figure-value {
            font-size: clamp(1.75rem, 4vw, 2.5rem); /* Min, preferred, max font size */
            line-height: 1.1;
        }

        /* Added animation for modals */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased">

    <!-- Authentication Screen -->
    <div id="auth-screen" class="hidden h-screen w-screen flex flex-col justify-center items-center bg-slate-200 p-4">
        <div class="w-full max-w-md">
            <div class="bg-white shadow-lg rounded-lg p-8">
                <div class="text-center mb-6">
                    <span class="text-4xl">ðŸ’°</span>
                    <h1 class="text-2xl font-bold text-slate-800 mt-2">Spending Forecaster</h1>
                </div>
                <!-- Login Form -->
                <form id="login-form" class="">
                    <h2 class="text-xl font-semibold text-center text-slate-700 mb-4">Login</h2>
                    <div class="mb-4">
                        <label for="login-email" class="block text-slate-600 mb-1">Email</label>
                        <input type="email" id="login-email" required class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" autocomplete="email">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-slate-600 mb-1">Password</label>
                        <input type="password" id="login-password" required class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" autocomplete="current-password">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Login</button>
                </form>
                <!-- Sign-up Form -->
                <form id="signup-form" class="hidden">
                    <h2 class="text-xl font-semibold text-center text-slate-700 mb-4">Create Account</h2>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-slate-600 mb-1">Email</label>
                        <input type="email" id="signup-email" required class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" autocomplete="email">
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-slate-600 mb-1">Password</label>
                        <input type="password" id="signup-password" required class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" autocomplete="new-password">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">Sign Up</button>
                </form>
                <p id="auth-error" class="text-red-500 text-sm text-center mt-4 h-4"></p>
            </div>
            <div class="text-center mt-4">
                <a href="#" id="toggle-auth" class="text-sm text-blue-600 hover:underline">Need an account? Sign up</a>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen">
        <div class="flex h-full w-full">
            <!-- Collapsible Sidebar -->
            <nav id="sidebar" class="bg-slate-800 text-white flex flex-col transition-all duration-300 ease-in-out w-16 hover:w-56 overflow-hidden flex-shrink-0">
                <div class="flex-1">
                    <div class="flex items-center justify-center h-16 border-b border-slate-700">
                        <span class="text-2xl">ðŸ’°</span>
                    </div>
                    <ul class="flex flex-col py-4 space-y-2">
                        <li><button data-modal="settings" class="sidebar-item"><i class="fas fa-cog fa-fw w-6 text-center"></i><span class="ml-3">Settings & Balance</span></button></li>
                    </ul>
                </div>
                <div class="border-t border-slate-700">
                    <button id="logout-button" class="sidebar-item"><i class="fas fa-sign-out-alt fa-fw w-6 text-center"></i><span class="ml-3">Logout</span></button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col">
                <!-- Header -->
                <header class="bg-white shadow-md p-4 flex justify-between items-center flex-shrink-0">
                    <div class="flex items-baseline">
                        <h1 class="text-xl font-bold text-slate-700">Spending Forecaster</h1>
                        <span id="version-display" class="ml-3 text-xs font-medium text-slate-400"></span>
                    </div>
                </header>

                <!-- Content Area -->
                <div class="p-4 md:p-6 lg:p-8 overflow-y-auto flex-1">
                    <!-- Key Figures -->
                    <section id="key-figures" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></section>
                    
                    <!-- Data Cards -->
                    <section id="data-cards" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></section>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals (Overlay & Content) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
        <!-- Modal content will be injected here by JavaScript -->
    </div>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration (from external file) -->
    <script src="config.js"></script>
    
    <!-- App Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APP_VERSION = 'v2.3.1';
            const IS_PREVIEW_MODE = window.self !== window.top;

            // --- DOM ELEMENTS ---
            const authScreen = document.getElementById('auth-screen');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const toggleAuthLink = document.getElementById('toggle-auth');
            const authError = document.getElementById('auth-error');
            const logoutButton = document.getElementById('logout-button');

            // --- STATE MANAGEMENT ---
            const getInitialState = () => ({
                incomings: [],
                outgoings: [],
                adjustments: [],
                userId: null,
                activeOutgoingId: null,
            });
            let state = getInitialState();

            let db;
            let auth;
            let unsubFromFirestore = null;
            let isFirebaseConnected = false;

            // --- UI CONTROL ---
            const showLoginScreen = () => {
                authScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            };

            const showApp = () => {
                authScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
            };

            // --- FUNCTION DECLARATIONS ---
            const saveDataToLocalStorage = () => {
                localStorage.setItem('forecasterData', JSON.stringify(state));
                console.log("Data saved to Local Storage.");
            };

            const saveDataToFirebase = async () => {
                if (!state.userId) return;
                try {
                    const dataToSave = {
                        incomings: state.incomings,
                        outgoings: state.outgoings,
                        adjustments: state.adjustments
                    };
                    await db.collection('users').doc(state.userId).set(dataToSave);
                    console.log("Data saved to Firestore.");
                } catch (error) {
                    console.error("Error saving to Firestore:", error);
                    showNotification("Failed to save data to the cloud.", "error");
                }
            };

            const saveData = () => {
                if (isFirebaseConnected && state.userId) {
                    saveDataToFirebase();
                } else {
                    saveDataToLocalStorage();
                }
            };

            const renderApp = () => {
                renderKeyFigures();
                renderDataCards();
                document.getElementById('version-display').textContent = APP_VERSION;
            };

            const loadDataFromLocalStorage = () => {
                const data = localStorage.getItem('forecasterData');
                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        if (parsedData && typeof parsedData === 'object') {
                            state.incomings = parsedData.incomings || [];
                            state.outgoings = parsedData.outgoings || [];
                            state.adjustments = parsedData.adjustments || [];
                            console.log("Data loaded from Local Storage.");
                        }
                    } catch (e) {
                        console.error("Could not parse local storage data. Clearing it and starting fresh.", e);
                        localStorage.removeItem('forecasterData');
                    }
                }
                renderApp();
            };

            const loadDataFromFirebase = () => {
                if (unsubFromFirestore) unsubFromFirestore();

                unsubFromFirestore = db.collection('users').doc(state.userId)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            state.incomings = data.incomings || [];
                            state.outgoings = data.outgoings || [];
                            state.adjustments = data.adjustments || [];
                            console.log("Real-time data loaded/updated from Firestore.");
                        } else {
                            console.log("No existing data for this user. Saving initial blank state.");
                            saveDataToFirebase();
                        }
                        renderApp();
                    }, error => {
                        console.error("Error listening to Firestore:", error);
                        showNotification("Real-time sync failed. Falling back to local storage.", "error");
                        isFirebaseConnected = false;
                        loadDataFromLocalStorage();
                    });
            };

            const getSum = (arr, prop) => (arr || []).reduce((sum, item) => sum + (Number(item[prop]) || 0), 0);
            
            const formatDateUK = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('en-GB').format(date);
            };

            const calculateProjectedBalance = () => {
                const totalActualIncome = getSum(state.incomings, 'actual');
                const totalAdjustments = getSum(state.adjustments, 'amount');
                const totalSpent = (state.outgoings || []).reduce((sum, out) => sum + getSum(out.transactions, 'amount'), 0);
                return totalAdjustments + totalActualIncome - totalSpent;
            };

            const calculateFutureIncome = () => {
                return (state.incomings || [])
                    .filter(inc => !inc.actual || Number(inc.actual) === 0)
                    .reduce((sum, inc) => sum + (Number(inc.forecast) || 0), 0);
            };

            const calculateRemainingBudget = () => {
                return (state.outgoings || []).reduce((sum, out) => {
                    if (out.finalized) return sum;

                    const totalSpent = getSum(out.transactions, 'amount');
                    let remainingBudgetForOutgoing = 0;

                    if (out.type === 'itemized') {
                        (out.items || []).forEach(item => {
                            if (!item.finalized) {
                                const spentOnItem = (out.transactions || [])
                                    .filter(t => t.itemId === item.id)
                                    .reduce((itemSum, t) => itemSum + t.amount, 0);
                                const itemBudget = item.budget || 0;
                                remainingBudgetForOutgoing += (itemBudget - spentOnItem);
                            }
                        });
                    } else {
                        remainingBudgetForOutgoing = (out.budget || 0) - totalSpent;
                    }
                    
                    return sum + Math.max(0, remainingBudgetForOutgoing);
                }, 0);
            };

            const calculateForecastedYearEnd = () => {
                return calculateProjectedBalance() + calculateFutureIncome() - calculateRemainingBudget();
            };
            
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(value);
            };

            const renderKeyFigures = () => {
                const container = document.getElementById('key-figures');
                container.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-slate-500 font-semibold text-sm md:text-base">Projected Balance</h3>
                        <p class="key-figure-value font-bold text-slate-800">${formatCurrency(calculateProjectedBalance())}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow flex flex-col justify-between">
                        <div>
                            <h3 class="text-slate-500 font-semibold text-sm md:text-base flex items-center">
                                <i class="fas fa-arrow-trend-up text-green-500 mr-2"></i>
                                Future Income
                            </h3>
                            <p class="font-bold text-green-600 text-3xl">${formatCurrency(calculateFutureIncome())}</p>
                        </div>
                        <div class="mt-2">
                            <h3 class="text-slate-500 font-semibold text-sm md:text-base flex items-center">
                                <i class="fas fa-arrow-trend-down text-red-500 mr-2"></i>
                                Remaining Budget
                            </h3>
                            <p class="font-bold text-red-600 text-3xl">${formatCurrency(calculateRemainingBudget())}</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-slate-500 font-semibold text-sm md:text-base">Forecasted Year-End</h3>
                        <p class="key-figure-value font-bold text-blue-600">${formatCurrency(calculateForecastedYearEnd())}</p>
                    </div>
                `;
            };

            const renderDataCards = () => {
                const container = document.getElementById('data-cards');
                const outgoingsHtml = (state.outgoings || []).map(out => {
                    const spent = getSum(out.transactions, 'amount');
                    let budget = 0;

                    if (out.type === 'itemized') {
                        budget = (out.items || []).reduce((sum, item) => {
                            if (item.finalized) {
                                const spentOnItem = (out.transactions || [])
                                    .filter(t => t.itemId === item.id)
                                    .reduce((itemSum, t) => itemSum + t.amount, 0);
                                return sum + spentOnItem;
                            }
                            return sum + (item.budget || 0);
                        }, 0);
                    } else {
                        if (out.finalized) {
                            budget = spent;
                        } else {
                            budget = out.budget || 0;
                        }
                    }

                    const percentage = budget > 0 ? (spent / budget) * 100 : 0;
                    let progressBarColor = 'bg-green-500';
                    if (percentage > 90) progressBarColor = 'bg-red-500';
                    else if (percentage > 75) progressBarColor = 'bg-yellow-500';

                    return `
                        <li class="group flex items-center justify-between py-3 border-b border-slate-200 last:border-b-0">
                            <div class="flex-1 pr-4">
                                <div class="flex items-center">
                                    <span class="font-medium text-slate-700">${out.name}</span>
                                    ${out.type === 'itemized' ? '<i class="fas fa-list-ul text-slate-400 ml-2 text-xs"></i>' : ''}
                                    <button data-action="edit-outgoing" data-id="${out.id}" class="ml-2 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-pencil-alt fa-xs"></i></button>
                                </div>
                                <p class="text-sm text-slate-500">${formatCurrency(spent)} / ${formatCurrency(budget)}</p>
                                <div class="w-full bg-slate-200 rounded-full h-2.5 mt-1.5">
                                    <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>
                            </div>
                            <button data-action="manage-transactions" data-id="${out.id}" class="text-blue-600 font-semibold text-sm hover:text-blue-800 flex-shrink-0">Spend</button>
                        </li>
                    `;
                }).join('');

                const incomingsHtml = (state.incomings || []).map(inc => `
                    <li class="group flex items-center justify-between py-3 border-b border-slate-200 last:border-b-0">
                        <div>
                            <span class="font-medium text-slate-700">${inc.name}</span>
                            <button data-action="edit-income" data-id="${inc.id}" class="ml-2 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-pencil-alt fa-xs"></i></button>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-slate-500">Forecast: ${formatCurrency(inc.forecast)}</p>
                            <p class="text-sm font-semibold ${inc.actual > 0 ? 'text-green-600' : 'text-slate-600'}">Actual: ${formatCurrency(inc.actual)}</p>
                        </div>
                    </li>
                `).join('');

                container.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-800">Outgoings</h3>
                            <button data-modal="add-outgoing" class="bg-slate-200 text-slate-700 font-semibold px-3 py-1 rounded-lg text-sm hover:bg-slate-300 transition-colors">+ Add</button>
                        </div>
                        <ul class="space-y-2">${outgoingsHtml || '<p class="text-slate-500">No outgoing budgets added yet.</p>'}</ul>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-800">Incomings</h3>
                            <button data-modal="add-income" class="bg-slate-200 text-slate-700 font-semibold px-3 py-1 rounded-lg text-sm hover:bg-slate-300 transition-colors">+ Add</button>
                        </div>
                        <ul class="space-y-2">${incomingsHtml || '<p class="text-slate-500">No incoming items added yet.</p>'}</ul>
                    </div>
                `;
            };
            
            const modalContainer = document.getElementById('modal-container');
            let tempBudgetItems = [];
            
            const openModal = (modalType, data = null) => {
                let content = '';
                const modalShell = (title, body, footer) => `
                    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg animate-fade-in-up">
                        <div class="flex justify-between items-start">
                           <h2 class="text-xl font-bold mb-4 text-slate-800">${title}</h2>
                           <div id="modal-header-actions"></div>
                        </div>
                        <form id="modal-form">
                            <div class="modal-body">${body}</div>
                            <div class="modal-footer mt-6 flex justify-between items-center">${footer}</div>
                        </form>
                    </div>`;

                switch(modalType) {
                    case 'settings': {
                        const adjustmentsLog = (state.adjustments || []).sort((a, b) => new Date(b.date) - new Date(a.date)).map(adj => `
                            <li class="flex justify-between text-sm py-1 border-b">
                                <span>${formatDateUK(adj.date)}: ${adj.desc}</span>
                                <span class="font-medium ${adj.amount >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(adj.amount)}</span>
                            </li>`).join('');
                        const body = `
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-slate-700 mb-2">Reconcile Balance</h3>
                                <p class="text-sm text-slate-500 mb-2">To get started, enter your current bank balance here. Use this regularly to keep the app in sync with your bank.</p>
                                <p class="mb-1 text-sm">App's Projected Balance: <span class="font-bold text-slate-800">${formatCurrency(calculateProjectedBalance())}</span></p>
                                <div id="reconcile-form-inputs" class="flex gap-4 mt-2">
                                    <input id="actualBalanceInput" type="number" step="0.01" class="flex-grow p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Your actual bank balance">
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Reconcile</button>
                                </div>
                            </div>

                            <div class="border-t pt-4">
                                <h3 class="text-lg font-bold mb-2 text-slate-700">Reconciliation Log</h3>
                                <ul class="max-h-48 overflow-y-auto bg-slate-50 p-2 rounded-md">${adjustmentsLog || '<li>No adjustments recorded.</li>'}</ul>
                            </div>
                        `;
                        const footer = `<span></span><button data-action="cancel-modal" type="button" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Close</button>`;
                        content = modalShell('Settings & Balance', body, footer);
                        break;
                    }
                    case 'add-outgoing':
                    case 'edit-outgoing': {
                        const isEdit = modalType === 'edit-outgoing';
                        const out = isEdit ? state.outgoings.find(o => o.id === data) : {};
                        tempBudgetItems = isEdit && out.items ? [...out.items] : [];
                        
                        const body = `
                            <div class="mb-4">
                                <label for="outgoingName" class="block mb-2 font-medium text-slate-600">Name</label>
                                <input id="outgoingName" type="text" value="${isEdit ? out.name : ''}" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Summer Holiday" required>
                            </div>
                            <div class="mb-4">
                                <label class="block mb-2 font-medium text-slate-600">Budget Type</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center"><input type="radio" name="budgetType" value="simple" class="mr-2" ${!isEdit || out.type !== 'itemized' ? 'checked' : ''}>Simple</label>
                                    <label class="flex items-center"><input type="radio" name="budgetType" value="itemized" class="mr-2" ${isEdit && out.type === 'itemized' ? 'checked' : ''}>Itemized</label>
                                </div>
                            </div>
                            <!-- Simple Budget -->
                            <div id="simple-budget-section" class="${isEdit && out.type === 'itemized' ? 'hidden' : ''}">
                                <label for="outgoingBudget" class="block mb-2 font-medium text-slate-600">Total Budget</label>
                                <input id="outgoingBudget" type="number" step="0.01" value="${isEdit && out.type !== 'itemized' ? out.budget : ''}" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 2000">
                            </div>
                            <!-- Itemized Budget -->
                            <div id="itemized-budget-section" class="${!isEdit || out.type !== 'itemized' ? 'hidden' : ''}">
                                <h4 class="font-semibold text-slate-700 mb-2">Budget Items</h4>
                                <ul id="budget-items-list" class="max-h-40 overflow-y-auto bg-slate-50 p-2 rounded-md mb-2 border"></ul>
                                <div id="add-item-form" class="flex gap-2 items-center">
                                    <input id="itemName" type="text" placeholder="Item name" class="flex-grow p-2 border rounded-lg">
                                    <input id="itemBudget" type="number" step="0.01" placeholder="Budget" class="w-32 p-2 border rounded-lg">
                                    <button type="button" id="add-item-btn" class="px-3 py-2 bg-green-600 text-white rounded-lg font-semibold text-sm hover:bg-green-700">Add</button>
                                </div>
                                <p class="text-right font-bold text-slate-800 mt-2">Total: <span id="itemized-total">Â£0.00</span></p>
                            </div>
                        `;
                        const footer = `
                            <div>${isEdit ? `<button data-action="delete-item" data-type="outgoing" data-id="${data}" type="button" class="text-red-600 font-semibold hover:underline">Delete Item</button>` : ''}</div>
                            <div class="flex gap-4">
                                <button data-action="cancel-modal" type="button" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Cancel</button>
                                <button type="submit" data-id="${isEdit ? data : ''}" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Save</button>
                            </div>
                        `;
                        content = modalShell(isEdit ? 'Edit Outgoing' : 'Add Outgoing', body, footer);
                        break;
                    }
                    case 'add-income':
                    case 'edit-income': {
                        const isEditInc = modalType === 'edit-income';
                        const inc = isEditInc ? state.incomings.find(i => i.id === data) : {};
                        const body = `
                            <label for="incomeName" class="block mb-2 font-medium text-slate-600">Name</label>
                            <input id="incomeName" type="text" value="${isEditInc ? inc.name : ''}" class="w-full p-2 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-500" placeholder="e.g., Q1 Shares" required>
                            <label for="incomeForecast" class="block mb-2 font-medium text-slate-600">Forecast Amount</label>
                            <input id="incomeForecast" type="number" step="0.01" value="${isEditInc ? inc.forecast : ''}" class="w-full p-2 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-500" placeholder="e.g., 500" required>
                            <label for="incomeActual" class="block mb-2 font-medium text-slate-600">Actual Amount (0 if not received)</label>
                            <input id="incomeActual" type="number" step="0.01" value="${isEditInc ? inc.actual : ''}" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 550">
                        `;
                        const footer = `
                            <div>${isEditInc ? `<button data-action="delete-item" data-type="income" data-id="${data}" type="button" class="text-red-600 font-semibold hover:underline">Delete Item</button>` : ''}</div>
                            <div class="flex gap-4">
                                <button data-action="cancel-modal" type="button" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Cancel</button>
                                <button type="submit" data-id="${isEditInc ? data : ''}" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Save</button>
                            </div>
                        `;
                        content = modalShell(isEditInc ? 'Edit Income' : 'Add Income', body, footer);
                        break;
                    }
                    case 'manage-transactions': {
                        state.activeOutgoingId = data;
                        const activeOutgoing = state.outgoings.find(o => o.id === data);
                        let itemizedSummaryHtml = '';
                        let transactionCategoryHtml = '';

                        if (activeOutgoing.type === 'itemized') {
                            itemizedSummaryHtml = (activeOutgoing.items || []).map(item => {
                                const spentOnItem = (activeOutgoing.transactions || [])
                                    .filter(t => t.itemId === item.id)
                                    .reduce((itemSum, t) => itemSum + t.amount, 0);
                                const lockIcon = item.finalized ? 'fa-lock' : 'fa-unlock';
                                const lockColor = item.finalized ? 'text-slate-500' : 'text-blue-500';
                                return `
                                    <li class="flex justify-between items-center text-sm py-1">
                                        <span class="font-medium">${item.name}</span>
                                        <div class="flex items-center gap-x-3">
                                            <span>${formatCurrency(spentOnItem)} / ${formatCurrency(item.budget)}</span>
                                            <button type="button" data-action="toggle-finalize-item" data-item-id="${item.id}" class="${lockColor} hover:opacity-75">
                                                <i class="fas ${lockIcon}"></i>
                                            </button>
                                        </div>
                                    </li>
                                `;
                            }).join('');

                            const itemOptions = (activeOutgoing.items || [])
                                .map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                            
                            transactionCategoryHtml = `
                                <select id="transactionItem" class="w-40 p-2 border rounded-lg text-sm">
                                    <option value="">-- Category --</option>
                                    ${itemOptions}
                                </select>
                            `;
                        }

                        const transactionsHtml = (activeOutgoing.transactions || []).map(t => {
                            let categoryName = '';
                            if (activeOutgoing.type === 'itemized' && t.itemId) {
                                const item = (activeOutgoing.items || []).find(i => i.id === t.itemId);
                                if (item) categoryName = `<span class="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full">${item.name}</span>`;
                            }
                            return `
                                <li class="flex justify-between items-center text-sm py-2 border-b group">
                                    <div class="flex items-center gap-x-2">
                                        ${categoryName}
                                        <span>${t.desc}</span>
                                    </div>
                                    <div class="flex items-center gap-x-3">
                                        <span class="font-medium text-slate-700">${formatCurrency(t.amount)}</span>
                                        <button data-action="delete-transaction" data-transaction-id="${t.id}" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i class="fas fa-trash-alt fa-sm"></i>
                                        </button>
                                    </div>
                                </li>
                            `;
                        }).join('');

                        const body = `
                            ${itemizedSummaryHtml ? `<div class="mb-4 border-b pb-2"><h4 class="font-semibold text-slate-700 mb-1">Itemized Summary</h4><ul class="space-y-0.5">${itemizedSummaryHtml}</ul></div>` : ''}
                            <div class="mb-4 border rounded-lg p-3 bg-slate-50 max-h-48 overflow-y-auto">
                                <ul class="space-y-1">${transactionsHtml || '<li class="text-slate-500">No transactions yet.</li>'}</ul>
                            </div>
                            <h3 class="text-base font-semibold mb-2 text-slate-700">Add New Transaction</h3>
                            <div id="add-transaction-inputs" class="flex flex-wrap gap-2">
                                ${transactionCategoryHtml}
                                <input id="transactionDesc" type="text" placeholder="Description" class="flex-grow p-2 border rounded-lg">
                                <input id="transactionAmount" type="number" step="0.01" placeholder="Amount" class="w-32 p-2 border rounded-lg">
                                <button type="submit" class="px-4 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">Add</button>
                            </div>
                        `;
                        const footer = `<span></span><button data-action="cancel-modal" type="button" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Close</button>`;
                        content = modalShell(`Transactions for ${activeOutgoing.name}`, body, footer);
                        break;
                    }
                    case 'confirm-delete': {
                        const body = `<p class="text-slate-600">Are you sure you want to permanently delete this item? This action cannot be undone.</p>`;
                        const footer = `
                            <button data-action="cancel-modal" type="button" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Cancel</button>
                            <button data-action="execute-delete" data-type="${data.type}" data-id="${data.id}" type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">Confirm Delete</button>
                        `;
                        content = modalShell('Confirm Deletion', body, footer);
                        break;
                    }
                }
                
                modalContainer.innerHTML = content;
                modalContainer.classList.remove('hidden');

                if (modalType === 'add-outgoing' || modalType === 'edit-outgoing') {
                    setupOutgoingModal(data);
                } else if (modalType === 'manage-transactions') {
                    const activeOutgoing = state.outgoings.find(o => o.id === data);
                    if (activeOutgoing && activeOutgoing.type !== 'itemized') {
                        const modalHeaderActions = modalContainer.querySelector('#modal-header-actions');
                        const lockIcon = activeOutgoing.finalized ? 'fa-lock' : 'fa-unlock';
                        const lockColor = activeOutgoing.finalized ? 'text-slate-500' : 'text-blue-500';
                        modalHeaderActions.innerHTML = `
                            <button type="button" data-action="toggle-finalize-simple" class="${lockColor} hover:opacity-75 text-lg">
                                <i class="fas ${lockIcon}"></i>
                            </button>
                        `;
                    }
                }
            };
            
            const closeModal = () => {
                modalContainer.classList.add('hidden');
                modalContainer.innerHTML = '';
                state.activeOutgoingId = null;
                tempBudgetItems = [];
            };

            const showNotification = (message, type = 'info') => {
                const colors = {
                    info: 'bg-blue-500',
                    success: 'bg-green-500',
                    error: 'bg-red-500'
                };
                const notification = document.createElement('div');
                notification.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg ${colors[type]} animate-fade-in-up`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            };

            const setupOutgoingModal = (outgoingId) => {
                const simpleSection = document.getElementById('simple-budget-section');
                const itemizedSection = document.getElementById('itemized-budget-section');
                const budgetTypeRadios = document.querySelectorAll('input[name="budgetType"]');
                const addItemBtn = document.getElementById('add-item-btn');
                const budgetItemsList = document.getElementById('budget-items-list');
                const itemizedTotalEl = document.getElementById('itemized-total');

                const renderItems = () => {
                    budgetItemsList.innerHTML = tempBudgetItems.map((item, index) => `
                        <li class="flex justify-between items-center text-sm p-1">
                            <span>${item.name} - ${formatCurrency(item.budget)}</span>
                            <button type="button" data-action="remove-budget-item" data-index="${index}" class="text-red-500 hover:text-red-700">&times;</button>
                        </li>
                    `).join('');
                    const total = tempBudgetItems.reduce((sum, item) => sum + item.budget, 0);
                    itemizedTotalEl.textContent = formatCurrency(total);
                };

                budgetTypeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.value === 'simple') {
                            simpleSection.classList.remove('hidden');
                            itemizedSection.classList.add('hidden');
                        } else {
                            simpleSection.classList.add('hidden');
                            itemizedSection.classList.remove('hidden');
                        }
                    });
                });

                addItemBtn.addEventListener('click', () => {
                    const nameInput = document.getElementById('itemName');
                    const budgetInput = document.getElementById('itemBudget');
                    const name = nameInput.value.trim();
                    const budget = parseFloat(budgetInput.value);

                    if (name && !isNaN(budget) && budget > 0) {
                        tempBudgetItems.push({ id: crypto.randomUUID(), name, budget, finalized: false });
                        renderItems();
                        nameInput.value = '';
                        budgetInput.value = '';
                        nameInput.focus();
                    } else {
                        showNotification('Please enter a valid item name and budget.', 'error');
                    }
                });

                budgetItemsList.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-action="remove-budget-item"]');
                    if (button) {
                        const index = parseInt(button.dataset.index, 10);
                        tempBudgetItems.splice(index, 1);
                        renderItems();
                    }
                });

                renderItems();
            };
            
            // --- EVENT LISTENERS ---
            
            logoutButton.addEventListener('click', () => {
                if (isFirebaseConnected) {
                    auth.signOut();
                }
            });

            toggleAuthLink.addEventListener('click', (e) => {
                e.preventDefault();
                authError.textContent = '';
                if (loginForm.classList.contains('hidden')) {
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                    toggleAuthLink.textContent = 'Need an account? Sign up';
                } else {
                    loginForm.classList.add('hidden');
                    signupForm.classList.remove('hidden');
                    toggleAuthLink.textContent = 'Have an account? Login';
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                authError.textContent = '';
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        console.error("Login failed:", error);
                        authError.textContent = error.message;
                    });
            });

            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                authError.textContent = '';
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                auth.createUserWithEmailAndPassword(email, password)
                    .catch(error => {
                        console.error("Sign up failed:", error);
                        authError.textContent = error.message;
                    });
            });

            document.getElementById('sidebar').addEventListener('click', e => {
                const button = e.target.closest('button[data-modal]');
                if (button) {
                    openModal(button.dataset.modal);
                }
            });

            document.getElementById('data-cards').addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;

                const { action, modal, id } = target.dataset;
                if(modal) {
                     openModal(modal);
                } else if (action) {
                    openModal(action, id);
                }
            });

            modalContainer.addEventListener('click', e => {
                const target = e.target;
                const button = target.closest('button');
                
                if (target === modalContainer) {
                    closeModal();
                    return;
                }
                
                if (!button) return;

                const { action, id, type, transactionId, itemId } = button.dataset;

                switch(action) {
                    case 'cancel-modal':
                        closeModal();
                        break;
                    case 'delete-item': {
                        openModal('confirm-delete', { type, id });
                        break;
                    }
                    case 'execute-delete': {
                        if (type === 'outgoing') {
                            state.outgoings = state.outgoings.filter(o => o.id !== id);
                        } else if (type === 'income') {
                            state.incomings = state.incomings.filter(i => i.id !== id);
                        }
                        saveData();
                        if (!isFirebaseConnected) renderApp();
                        closeModal();
                        showNotification('Item deleted.', 'success');
                        break;
                    }
                    case 'delete-transaction': {
                        const outgoingId = state.activeOutgoingId;
                        const outgoing = state.outgoings.find(o => o.id === outgoingId);
                        if (outgoing && transactionId) {
                            outgoing.transactions = outgoing.transactions.filter(t => t.id !== transactionId);
                            saveData();
                            if (!isFirebaseConnected) renderApp();
                            openModal('manage-transactions', outgoingId);
                            showNotification('Transaction deleted.', 'success');
                        }
                        break;
                    }
                    case 'toggle-finalize-item': {
                        const outgoingId = state.activeOutgoingId;
                        const outgoing = state.outgoings.find(o => o.id === outgoingId);
                        if (outgoing && outgoing.items && itemId) {
                            const item = outgoing.items.find(i => i.id === itemId);
                            if (item) {
                                item.finalized = !item.finalized;
                                saveData();
                                if (!isFirebaseConnected) renderApp();
                                openModal('manage-transactions', outgoingId);
                                showNotification(`Item ${item.finalized ? 'finalized' : 'un-finalized'}.`, 'success');
                            }
                        }
                        break;
                    }
                    case 'toggle-finalize-simple': {
                        const outgoingId = state.activeOutgoingId;
                        const outgoing = state.outgoings.find(o => o.id === outgoingId);
                        if (outgoing) {
                            outgoing.finalized = !outgoing.finalized;
                            saveData();
                            if (!isFirebaseConnected) renderApp();
                            openModal('manage-transactions', outgoingId);
                            showNotification(`Budget ${outgoing.finalized ? 'finalized' : 'un-finalized'}.`, 'success');
                        }
                        break;
                    }
                }
            });

            modalContainer.addEventListener('submit', e => {
                e.preventDefault();
                const formId = e.target.id;
                const modalForm = e.target.closest('#modal-form');
                
                if (formId === 'modal-form') {
                    const title = modalForm.parentElement.querySelector('h2').textContent;
                    if (title.includes('Outgoing')) {
                        const outgoingId = modalForm.querySelector('button[type="submit"]').dataset.id;
                        const name = document.getElementById('outgoingName').value.trim();
                        const budgetType = document.querySelector('input[name="budgetType"]:checked').value;
                        
                        const newOutgoing = {
                            id: outgoingId || crypto.randomUUID(),
                            name,
                            type: budgetType,
                            transactions: outgoingId ? state.outgoings.find(o=>o.id === outgoingId).transactions : []
                        };

                        if (budgetType === 'simple') {
                            const budget = parseFloat(document.getElementById('outgoingBudget').value);
                            if (isNaN(budget)) return showNotification('Please enter a valid budget.', 'error');
                            newOutgoing.budget = budget;
                            newOutgoing.finalized = false; // Default for new simple budgets
                        } else {
                            if (tempBudgetItems.length === 0) return showNotification('Please add at least one budget item.', 'error');
                            newOutgoing.items = tempBudgetItems;
                        }

                        if (outgoingId) {
                            const index = state.outgoings.findIndex(o => o.id === outgoingId);
                            state.outgoings[index] = newOutgoing;
                        } else {
                            state.outgoings.push(newOutgoing);
                        }
                        showNotification('Outgoing saved.', 'success');
                    } else if (title.includes('Income')) {
                        const name = document.getElementById('incomeName').value.trim();
                        const forecast = document.getElementById('incomeForecast').value;
                        const actual = document.getElementById('incomeActual').value;
                        if (!name || !forecast) return showNotification('Name and Forecast are required.', 'error');
                        
                        const incomeId = modalForm.querySelector('button[type="submit"]').dataset.id;
                        if (incomeId) {
                            const inc = state.incomings.find(i => i.id === incomeId);
                            if (inc) {
                                inc.name = name;
                                inc.forecast = parseFloat(forecast);
                                inc.actual = parseFloat(actual) || 0;
                            }
                        } else {
                            state.incomings.push({ id: crypto.randomUUID(), name, forecast: parseFloat(forecast), actual: parseFloat(actual) || 0 });
                        }
                        showNotification('Income saved.', 'success');
                    } else if (title.includes('Settings')) {
                        const actualBalanceInput = document.getElementById('actualBalanceInput');
                        const actualBalance = parseFloat(actualBalanceInput.value);
                        if (isNaN(actualBalance)) return showNotification('Please enter a valid actual balance.', 'error');

                        const projected = calculateProjectedBalance();
                        const difference = actualBalance - projected;
                        
                        if (Math.abs(difference) > 0.001) {
                             state.adjustments.push({
                                id: crypto.randomUUID(),
                                desc: 'Balance Reconciliation',
                                amount: difference,
                                date: new Date().toISOString()
                             });
                             showNotification('Balance reconciled.', 'success');
                        }
                    } else if (title.includes('Transactions')) {
                        const desc = document.getElementById('transactionDesc').value.trim();
                        const amount = document.getElementById('transactionAmount').value;
                        const outgoing = state.outgoings.find(o => o.id === state.activeOutgoingId);
                        
                        if (!desc || !amount) return showNotification('Please provide description and amount.', 'error');
                        
                        let itemId = null;
                        if (outgoing.type === 'itemized') {
                            itemId = document.getElementById('transactionItem').value;
                            if (!itemId) return showNotification('Please select a category for this transaction.', 'error');
                        }

                        if(outgoing) {
                            if (!outgoing.transactions) outgoing.transactions = [];
                            outgoing.transactions.push({id: crypto.randomUUID(), desc, amount: parseFloat(amount), itemId});
                            openModal('manage-transactions', state.activeOutgoingId);
                        }
                    }

                    saveData();
                    if (!isFirebaseConnected) renderApp();
                    if (!title.includes('Transactions')) {
                        closeModal();
                    }
                }
            });

            // --- INITIALIZATION ---
            if (IS_PREVIEW_MODE) {
                // PREVIEW MODE: Bypass auth and use local storage
                console.log("Running in Preview Mode.");
                showNotification("Running in offline preview mode.", "info");
                showApp();
                loadDataFromLocalStorage();
            } else {
                // LIVE MODE: Use Firebase Authentication
                try {
                    if (typeof firebaseConfig === 'undefined' || firebaseConfig.apiKey.includes("YOUR_")) {
                         throw new Error("Firebase config is not defined or is a placeholder.");
                    }
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    isFirebaseConnected = true;
                    
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            console.log("User is signed in:", user.uid);
                            state.userId = user.uid;
                            showApp();
                            loadDataFromFirebase();
                        } else {
                            console.log("User is signed out.");
                            if (unsubFromFirestore) unsubFromFirestore();
                            state = getInitialState();
                            showLoginScreen();
                        }
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error.message);
                    showLoginScreen();
                    authError.innerHTML = `<strong>Cloud Connection Failed.</strong><br>Check your config and Firebase project setup.`;
                }
            }
        });
    </script>
</body>
</html>
